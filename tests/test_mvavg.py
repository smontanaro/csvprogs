#!/usr/bin/env python

"mvavg tests"

import csv
import io
import subprocess
import unittest

EPS = 1e-7

class MATest(unittest.TestCase):
    "test"
    input_data = """\
date,weight,hr,O2
2024-09-07,179.8,50,95
2024-09-08,180.4,48,96
2024-09-09,181.4,51,96
2024-09-10,182.8,54,93
2024-09-11,180.8,53,95
2024-09-12,182.0,47,95
2024-09-13,182.6,51,96
2024-09-14,182.4,53,94
2024-09-15,
2024-09-16,181.8,53,94
2024-09-17,181.8,57,96
2024-09-18,183.4
2024-09-19,183.6
2024-09-20,185.4,55,95
2024-09-21,184.8,48,95
2024-09-22,183.0,53,96
2024-09-23,184.0
2024-09-24,182.0,52,96
2024-09-25,182.8,53,95
2024-09-26,180.8,50,94
2024-09-27,182.6
2024-09-28,183.6,48,96
2024-09-29,
2024-09-30,
2024-10-01,
2024-10-02,
2024-10-03,
2024-10-04,
2024-10-05,
2024-10-06,
2024-10-07,
2024-10-08,
2024-10-09,
2024-10-10,
2024-10-11,
2024-10-12,
2024-10-13,
2024-10-14,
2024-10-15,
2024-10-16,
2024-10-17,
2024-10-18,
2024-10-19,
2024-10-20,
2024-10-21,
2024-10-22,
2024-10-23,182
2024-10-24,183.8,55,96
2024-10-25,181.0,51,96
2024-10-26,181.0,51,97
2024-10-27,181.0,55,96
2024-10-28,182.8,52,96
2024-10-29,183.2,49,96
2024-10-30,182.6,52,95
2024-10-31,182.8,53,94
2024-11-01,182.6,48,94
2024-11-02,183.6,48,95
2024-11-03,182.6
2024-11-04,181.0,56,97
2024-11-05,180.6,59,94
2024-11-06,181.6,53,96
2024-11-07,182.8,45,98
2024-11-08,182.0,49,97
2024-11-09,181.8,48,96
2024-11-10,182.0,46,96
2024-11-11,183.0,45,97
2024-11-12,181.8,46,96
"""

    def test_cli(self):
        result = subprocess.run(["./venv/bin/python", "-m", "csvprogs.mvavg",
            "-f", "weight", "-n", "5", "--column", "mean"], check=True,
            stdout=subprocess.PIPE, stderr=None,
            input=bytes(self.input_data, encoding="utf-8"))
        assert result.returncode == 0
        csvdata = list(csv.DictReader(io.StringIO(result.stdout.decode("utf-8"))))
        assert set(x["mean"] for x in csvdata[0:3]) == set(["nan"])
        m4 = float(csvdata[4]["mean"])
        assert abs(m4 - 181.04) < EPS, (m4, (m4 - 181.92))


if __name__ == "__main__":
    unittest.main()
